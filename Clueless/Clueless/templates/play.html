{% load static from staticfiles %}
{% block content %}
{% load static %}
    <!--<meta http-equiv="refresh" content="1">-->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script  type="text/javascript">        
        console.log("Current data, per user:");
        console.log("Is it Player\'s turn:", "{{ player_turn }}");
        console.log("Game Id:", {{ game_id }});
        console.log("Is Player Game Creator:", {{ is_creator | safe }});
        console.log("Is it Player\'s turn:", {{ player_turn | safe }});
        console.log("Player Location:", {{ player_location | safe }});
        console.log("Others Locations:", {{ others_locations | safe }})
        console.log("Player Hand:", {{ player_hand | safe}});
        console.log("All Available Cards:", {{ available_cards | safe}});
        console.log("Solution Cards:", {{ solution_cards | safe}});
        console.log("Suggested Cards:", {{ suggested_cards | safe}});
        console.log("Player Status: ", {{ player_status | safe }});
        console.log("Game Status: ", {{ game_status | safe }});
        console.log("Game Winner: ", {{ game_winner | safe }})

        var solution_cards = {{ solution_cards | safe}};

        const idToText = {
            weapon1: {
                name: "Candlestick"
            },
            weapon2: {
                name: "Knife"
            },
            weapon3: {
                name: "Lead Pipe"
            },
            weapon4: {
                name: "Revolver"
            },
            weapon5: {
                name: "Rope"
            },
            weapon6: {
                name: "Wrench"
            },
            room1: {
                name: "Ballroom",
                connections: [
                    "hallway9", 
                    "hallway11",
                    "hallway12"
                ]
            },
            room2: {
                name: "Billiard Room",
                connections: [
                    "hallway4",
                    "hallway6",
                    "hallway7",
                    "hallway9"
                ]
            },
            room3: {
                name: "Conservatory",
                connections: [
                    "hallway8",
                    "hallway11",
                    "room8"
                ]
            },
            room4: {
                name: "Dining Room",
                connections: [
                    "hallway5",
                    "hallway7",
                    "hallway10"
                ]
            },
            room5: {
                name: "Hall",
                connections: [
                    "hallway1",
                    "hallway2",
                    "hallway4"
                ]
            },
            room6: {
                name: "Kitchen",
                connections: [
                    "hallway10",
                    "hallway12",
                    "room9"
                ]
            },
            room7: {
                name: "Library",
                connections: [
                    "hallway3",
                    "hallway6",
                    "hallway8"
                ]
            },
            room8: {
                name: "Lounge",
                connections: [
                    "hallway2",
                    "hallway5",
                    "room3"
                ]
            },
            room9: {
                name: "Study",
                connections: [
                    "hallway1",
                    "hallway3",
                    "room6"
                ]
            },
            hallway1: {
                name: getHallwayName("Hall", "Study"),
                connections: [
                    "room5",
                    "room9"
                ]
            },
            hallway2: {
                name: getHallwayName("Hall", "Lounge"),
                connections: [
                    "room5",
                    "room8"
                ]
            },
            hallway3: {
                name: getHallwayName("Study", "Library"),
                connections: [
                    "room7",
                    "room9"
                ]
            },
            hallway4: {
                name: getHallwayName("Hall", "Billiard Room"),
                connections: [
                    "room5",
                    "room2"
                ]
            },
            hallway5: {
                name: getHallwayName("Lounge", "Dining Room"),
                connections: [
                    "room8",
                    "room4"
                ]
            },
            hallway6: {
                name: getHallwayName("Billiard Room", "Library"),
                connections: [
                    "room2",
                    "room7"
                ]
            },
            hallway7: {
                name: getHallwayName("Billiard Room", "Dining Room"),
                connections: [
                    "room2",
                    "room4"
                ]
            },
            hallway8: {
                name: getHallwayName("Library", "Conservatory"),
                connections: [
                    "room7",
                    "room3"
                ]
            },
            hallway9: {
                name: getHallwayName("Billiard Room", "Ballroom"),
                connections: [
                    "room2",
                    "room1"
                ]
            },
            hallway10: {
                name: getHallwayName("Dining Room", "Kitchen"),
                connections: [
                    "room4",
                    "room6"
                ]
            },
            hallway11: {
                name: getHallwayName("Conservatory", "Ballroom"),
                connections: [
                    "room3",
                    "room1"
                ]
            },
            hallway12: {
                name: getHallwayName("Ballroom", "Kitchen"),
                connections: [
                    "room1",
                    "room6"
                ]
            },
            suspect1: {
                name: "Colonel Mustard"
            },
            suspect2: {
                name: "Miss Scarlet"
            },
            suspect3: {
                name: "Mr. Green"
            },
            suspect4: {
                name: "Mrs. Peacock"
            },
            suspect5: {
                name: "Mrs. White"
            },
            suspect6: {
                name: "Professor Plum"
            }
        }

        const textToId = {
            "Candlestick": "weapon1",
            "Knife": "weapon2",
            "Lead Pipe": "weapon3",
            "Revolver": "weapon4",
            "Rope": "weapon5",
            "Wrench": "weapon6",
            "Ballroom": "room1",
            "Billiard Room": "room2",
            "Conservatory": "room3",
            "Dining Room": "room4",
            "Hall": "room5",
            "Kitchen": "room6",
            "Library": "room7",
            "Lounge": "room8",
            "Study": "room9",
            "Colonel Mustard": "suspect1",
            "Miss Scarlet": "suspect2",
            "Mr. Green": "suspect3",
            "Mrs. Peacock": "suspect4",
            "Mrs. White": "suspect5",
            "Professor Plum": "suspect6"
        }

        function getHallwayName(room1, room2) {
            return "Hallway from " + room1 + " to " + room2;
        }

        function addItemToList(item, listToAddTo) {
            var list = document.getElementById(listToAddTo);
            var option = document.createElement("option");
            option.text = idToText[item].name;
            option.value = item;
            list.add(option);
        }

        $(document).ready(function() {
            // construct player's hand
            playerHand = {{ player_hand | safe}};
            //const playerHand = JSON.parse("{{ player_hand | safe}}");


            Object.keys(playerHand).forEach(cardType => {
                playerHand[cardType].forEach(card => {
                    $("#player-hand").append(
                        "<li>" + idToText[card].name + "</li>"
                    );
                });
            });

            // Notify player if they are the winner
            if( {{ game_status | safe }} == "COMPLETED"){
                alert( {{ game_winner | safe }} +" has won the game!!");
                location.replace("/");
            };

            // Player's turn options
            if (!"{{ player_turn }}") {
                $(".is-players-turn").hide();
            } else {
                $(".is-players-turn").hide();
                $("#turn-options-menu").show();
            }

            // Notify player of current location
            $("#player-location-msg").text("You are in the " + idToText[{{ player_location | safe }}].name);

            // initialize suspect, weapon, and location options
            Object.keys(idToText).forEach(id => {
                if (id.includes("room")) {
                    addItemToList(id, "accuse-location");
                } else if (id.includes("suspect")) {
                    addItemToList(id, "accuse-suspect");
                    addItemToList(id, "suggest-suspect");
                } else if (id.includes("weapon")) {
                    addItemToList(id, "accuse-weapon");
                    addItemToList(id, "suggest-weapon");
                }
            });

            // Listen for game updates if not player's turn
            if( !{{player_turn | yesno:"true,false"}}) {
                if(!$.isEmptyObject( {{ suggested_cards | safe}} )){
                    alert("Suggestion was made!!!");
                    alert("Players will have option to rebuke suggestion!!");
                }
                else{
                    setInterval(function(){
                        $.ajax({
                            type: "GET",
                            url: "/play/",
                            success: function() {
                                location.reload();
                            }
                        });
                    }, 5000);
                }
            };
        });

        function showTurnOptions() {
            $(".is-players-turn").hide();
            $("#turn-options-menu").show();
        }

        function move() {
            $("#move-options").empty();
            let moveOptions = idToText[{{ player_location | safe }}].connections;
            moveOptions.forEach(move => {
                var move_list = document.getElementById("move-options");
                var option = document.createElement("option");
                option.text = idToText[move].name;
                move_list.add(option);
            });
            $("#turn-options-menu").hide();
            $("#move-options-menu").show();
        }

        function movePlayer(){
            var move = document.getElementById("move-options");
            l = idToText[{{ player_location | safe }}].connections[move.selectedIndex];

            url = "/play/?player_location="+l;

            $.ajax({
                type: "POST",
                url: url,
                success: function() {
                    location.reload();
                }
            });
        }

        function suggest() {
            $("#turn-options-menu").hide();
            $("#make-suggestion-menu").show();
        }

        function accuse() {
            $("#turn-options-menu").hide();
            $("#make-accusation-menu").show();
        }

        function rebuke() {
            $("#rebuke-options").empty();

            const playerHand = {{ player_hand | safe}};
            const suggestedCards = {{ suggested_cards | safe}};

            Object.keys(playerHand).forEach(cardType => {
                playerHand[cardType].forEach(card => {
                    //alert(card);
                    //alert(suggestedCards[cardType]);

                    if(card == suggestedCards[cardType]){
                        var rebuke_list = document.getElementById("rebuke-options");
                        var option = document.createElement("option");
                        option.text = card;
                        rebuke_list.add(option);
                    };
                });
            });
            $("#turn-options-menu").hide();
            $("#rebuke-suggestion-menu").show();
        }

        function makeAccusation() {
            var weapon = $("#accuse-weapon option:selected").text();
            var room = $("#accuse-location option:selected").text();
            var suspect = $("#accuse-suspect option:selected").text();

            if(idToText[solution_cards["Weapons"][0]]["name"] == weapon &&
               idToText[solution_cards["Rooms"][0]]["name"] == room &&
               idToText[solution_cards["Suspects"][0]]["name"] == suspect){
                alert('You Won!!!');
                url = "/play/?player_status=won";
            }
            else{
                alert('You lost...');
                url = "/play/?player_status=lost";
            };

            $.ajax({
                type: "POST",
                url: url,
                success: function() {
                    location.reload();
                }
            });
        }

        function makeSuggestion() {

            var weapon = $("#suggest-weapon  option:selected").text();
            var suspect = $("#suggest-suspect option:selected").text();
            var room = {{player_location | safe }};

            url = "/play/?suggest_room=" + room +
                        "&suggest_weapon=" + textToId[weapon] +
                        "&suggest_suspect="+ textToId[suspect];

            $.ajax({
                type: "POST",
                url: url,
                success: function() {
                    location.reload();
                }
            });
        };

        function rebukeSuggestion() {

            var rebuke_card = $("#rebuke-options option:selected").text();

            var url = "/play/?rebuke_card=" + rebuke_card;
            $.ajax({
                type: "POST",
                url: url,
                success: function(){
                    location.reload();
                }
            });
        };

    </script>

    <body>
        <div class="jumbotron">
            <div class="container">
                <h2>Clue-Less: Play Game</h2>
            </div>
        </div>
        <div class="container">
            <div class="col-xs-12 col-sm-6">
                <h3 id="player-location-msg"></h3>
                <img src="{% static 'images/board.png' %}" alt="game board picture" style="width:75%">
            </div>
            <div class="col-xs-12 col-sm-6">
                <!-- Turn handling -->
                <div class="is-players-turn" id="turn-options-menu">
                    <h3>Turn Options</h3>
                    <ul id="turn-options">
                        <li onclick="move()">Move</li>
                        <li onclick="suggest()">Make a Suggestion</li>
                        <li onclick="accuse()">Make an Accusation</li>
                        <li onclick="rebuke()">Rebuke Suggestion</li>
                    </ul>
                </div>

                <div class="is-players-turn" id="move-options-menu">
                    <h3>Move Options</h3>
                    <button onclick="showTurnOptions()">Back to Turn Options</button>
                    <br><br>
                    <select id="move-options"></select>
                    <button onclick="movePlayer()">Move</button>
                    </ul>
                </div>

                <div class="is-players-turn" id="make-suggestion-menu">
                    <h3>Make a Suggestion</h3>
                    <button onclick="showTurnOptions()">Back to Turn Options</button>
                    <p>Choose one Weapon</p>
                    <select id="suggest-weapon"></select>
                    <p>Choose one Suspect</p>
                    <select id="suggest-suspect"></select>
                    <button onclick="makeSuggestion()">Suggest</button>
                </div>

                <div class="is-players-turn" id="make-accusation-menu">
                    <h3>Make an Accusation</h3>
                    <button onclick="showTurnOptions()">Back to Turn Options</button>
                    <p><em>NOTE: if you make an incorrect Accusation, you automatically lose the game.</em></p>
                    <p>Choose one Weapon</p>
                    <select id="accuse-weapon"></select>
                    <p>Choose one Suspect</p>
                    <select id="accuse-suspect"></select>
                    <p>Choose one Room</p>
                    <select id="accuse-location"></select>
                    <button onclick="makeAccusation()">Accuse</button>
                </div>

                <div class="is-players-turn" id="rebuke-suggestion-menu">
                    <h3>Make an Accusation</h3>
                    <button onclick="showTurnOptions()">Back to Turn Options</button>
                    <p>Choose Card from Hand</p>
                    <select id="rebuke-options"></select>
                    <button onclick="rebukeSuggestion()">Rebuke</button>
                </div>
                <!-- Player hand -->
                <h3>Your Hand</h3>
                <ul id="player-hand">
                </ul>
            </div>
        </div>
    </body>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Bootstrap JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

{% endblock %}