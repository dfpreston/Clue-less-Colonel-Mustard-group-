{% load staticfiles %}
{% block content %}
    <!--<meta http-equiv="refresh" content="1">-->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script  type="text/javascript">        
        console.log("Current data, per user:");
        console.log("Game Id:", "{{ game_id }}");
        console.log("Is Player Game Creator:", "{{ is_creator }}");
        console.log("Is it Players turn:", "{{ player_turn }}");
        console.log("Player Location:", "{{ player_location }}");
        console.log("Others Locations:", "{{ others_locations }}")
        console.log("Player Hand:", "{{ player_hand | safe}}");
        console.log("All Available Cards:", "{{ available_cards | safe}}");
        console.log("Solution Cards:", "{{ solution_cards | safe}}");
        console.log("Player Status: ", "{{ player_status | safe }}");
        console.log("Game Status: ", "{{ game_status | safe }}");
        console.log("Game Winner: ", "{{ game_winner | safe }}")

        var solution_cards = {{ solution_cards | safe}};

        const idToText = {
            weapon1: {
                name: "Candlestick"
            },
            weapon2: {
                name: "Knife"
            },
            weapon3: {
                name: "Lead Pipe"
            },
            weapon4: {
                name: "Revolver"
            },
            weapon5: {
                name: "Rope"
            },
            weapon6: {
                name: "Wrench"
            },
            room1: {
                name: "Ballroom",
                connections: [
                    "hallway9", 
                    "hallway11",
                    "hallway12"
                ]
            },
            room2: {
                name: "Billiard Room",
                connections: [
                    "hallway4",
                    "hallway6",
                    "hallway7",
                    "hallway9"
                ]
            },
            room3: {
                name: "Conservatory",
                connections: [
                    "hallway8",
                    "hallway11",
                    "room8"
                ]
            },
            room4: {
                name: "Dining Room",
                connections: [
                    "hallway5",
                    "hallway7",
                    "hallway10"
                ]
            },
            room5: {
                name: "Hall",
                connections: [
                    "hallway1",
                    "hallway2",
                    "hallway4"
                ]
            },
            room6: {
                name: "Kitchen",
                connections: [
                    "hallway10",
                    "hallway12",
                    "room9"
                ]
            },
            room7: {
                name: "Library",
                connections: [
                    "hallway3",
                    "hallway6",
                    "hallway8"
                ]
            },
            room8: {
                name: "Lounge",
                connections: [
                    "hallway2",
                    "hallway5",
                    "room3"
                ]
            },
            room9: {
                name: "Study",
                connections: [
                    "hallway1",
                    "hallway3",
                    "room6"
                ]
            },
            hallway1: {
                name: getHallwayName("room5", "room9"),
                connections: [
                    "room5",
                    "room9"
                ]
            },
            hallway2: {
                name: getHallwayName("room5", "room8"),
                connections: [
                    "room5",
                    "room8"
                ]
            },
            hallway3: {
                name: getHallwayName("room9", "room7"),
                connections: [
                    "room7",
                    "room9"
                ]
            },
            hallway4: {
                name: getHallwayName("room5", "room2"),
                connections: [
                    "room5",
                    "room2"
                ]
            },
            hallway5: {
                name: getHallwayName("room8", "room4"),
                connections: [
                    "room8",
                    "room4"
                ]
            },
            hallway6: {
                name: getHallwayName("room2", "room7"),
                connections: [
                    "room2",
                    "room7"
                ]
            },
            hallway7: {
                name: getHallwayName("room2", "room4"),
                connections: [
                    "room2",
                    "room4"
                ]
            },
            hallway8: {
                name: getHallwayName("room7", "room3"),
                connections: [
                    "room7",
                    "room3"
                ]
            },
            hallway9: {
                name: getHallwayName("room2", "room1"),
                connections: [
                    "room2",
                    "room1"
                ]
            },
            hallway10: {
                name: getHallwayName("room4", "room6"),
                connections: [
                    "room4",
                    "room6"
                ]
            },
            hallway11: {
                name: getHallwayName("room3", "room1"),
                connections: [
                    "room3",
                    "room1"
                ]
            },
            hallway12: {
                name: getHallwayName("room1", "room6"),
                connections: [
                    "room1",
                    "room6"
                ]
            },
            suspect1: {
                name: "Colonel Mustard"
            },
            suspect2: {
                name: "Miss Scarlet"
            },
            suspect3: {
                name: "Mr. Green"
            },
            suspect4: {
                name: "Mrs. Peacock"
            },
            suspect5: {
                name: "Mrs. White"
            },
            suspect6: {
                name: "Professor Plum"
            }
        }

        const textToId = {
            "Candlestick": "weapon1",
            "Knife": "weapon2",
            "Lead Pipe": "weapon3",
            "Revolver": "weapon4",
            "Rope": "weapon5",
            "Wrench": "weapon6",
            "Ballroom": "room1",
            "Billiard Room": "room2",
            "Conservatory": "room3",
            "Dining Room": "room4",
            "Hall": "room5",
            "Kitchen": "room6",
            "Library": "room7",
            "Lounge": "room8",
            "Study": "room9",
            "Colonel Mustard": "suspect1",
            "Miss Scarlet": "suspect2",
            "Mr. Green": "suspect3",
            "Mrs. Peacock": "suspect4",
            "Mrs. White": "suspect5",
            "Professor Plum": "suspect6"
        }

        function getHallwayName(room1, room2) {
            return "Hallway from " + room1 + " to " + room2;
        }

        $(document).ready(function() {
            // construct player's hand

            // convert player_hand to JSON. Globally replace &#39; with quotes
            const playerHand = JSON.parse("{{ player_hand }}".replace(/&#39;/g, "\""));

            Object.keys(playerHand).forEach(cardType => {
                playerHand[cardType].forEach(card => {
                    $("#player-hand").append(
                        "<li>" + idToText[card].name + "</li>"
                    );
                });
            });

            if( "{{ game_status | safe }}" == "COMPLETED"){
                alert( "{{ game_winner | safe }} has won the game!!");
                location.replace("/");
            };

            // Player's turn options
            if (!"{{ player_turn }}") {
                $(".is-players-turn").hide();
            } else {
                $(".is-players-turn").hide();
                $("#turn-options-menu").show();
            }

            // Notify player of current location
            $("#player-location-msg").text("You are in the " + idToText["{{ player_location }}"].name);

            // initialize suspect, weapon, and location options
            Object.keys(idToText).forEach(id => {
                if (id.includes("room")) {
                    //$(".location-options").append(
                    //    "<li>" + idToText[id].name + "</li>"
                    //);
                    var accuse_list = document.getElementById("accuse-location");
                    var suggest_list = document.getElementById("suggest-location");
                    var option_accuse = document.createElement("option");
                    option_accuse.text = idToText[id].name;
                    accuse_list.add(option_accuse);
                } else if (id.includes("suspect")) {
                    //$(".suspect-options").append(
                    //    "<li>" + idToText[id].name + "</li>"
                    //);
                    var accuse_list = document.getElementById("accuse-suspect");
                    var suggest_list = document.getElementById("suggest-suspect");
                    var option_accuse = document.createElement("option");
                    var option_suggest = document.createElement("option");
                    option_accuse.text = idToText[id].name;
                    option_suggest.text = idToText[id].name;
                    accuse_list.add(option_accuse);
                    suggest_list.add(option_suggest)
                } else if (id.includes("weapon")) {
                    //$(".weapon-options").append(
                    //    "<li>" + idToText[id].name + "</li>"
                    //);
                    var accuse_list = document.getElementById("accuse-weapon");
                    var suggest_list = document.getElementById("suggest-weapon");
                    var option_accuse = document.createElement("option");
                    var option_suggest = document.createElement("option");
                    option_accuse.text = idToText[id].name;
                    option_suggest.text = idToText[id].name;
                    accuse_list.add(option_accuse);
                    suggest_list.add(option_suggest)
                }
            });

            // Listen for game updates if not player's turn
            if( !{{player_turn | yesno:"true,false"}}) {
                setInterval(function(){
                    $.ajax({
                        type: "GET",
                        url: "/play/",
                        success: function() {
                            location.reload();
                        }
                    });
                    rebukeSuggestion();
                }, 5000);
            };
        });

        function showTurnOptions() {
            $(".is-players-turn").hide();
            $("#turn-options-menu").show();
        }

        function move() {
            $("#turn-options-menu").hide();
            $("#move-options-menu").show();
            $("#move-options").empty();
            let moveOptions = idToText["{{ player_location }}"].connections;
            moveOptions.forEach(move => {
                var move_list = document.getElementById("move-options");
                var option = document.createElement("option");
                option.text = idToText[move].name;
                move_list.add(option);
            });
        }

        function movePlayer(){

            var move = document.getElementById("move-options");
            l = idToText["{{ player_location }}"].connections[move.selectedIndex];

            url = "/play/?player_location="+l;

            $.ajax({
                type: "POST",
                url: url,
                success: function() {
                    location.reload();
                }
            });
        }

        function suggest() {
            $("#turn-options-menu").hide();
            $("#make-suggestion-menu").show();
        }

        function accuse() {
            $("#turn-options-menu").hide();
            $("#make-accusation-menu").show();
        }

        $(".move-location").click(function() {
            const newLocation = cardToId[$(this).text()];
            console.log(newLocation);
            updatePlayerLocation(location);
        })

        function updatePlayerLocation(newLocation) {
            const url = "/play/?new_location=" + new_location;
            $.ajax({
                type: "POST",
                url: url
            });
        };

        function makeAccusation() {
            var weapon = document.getElementById("accuse-weapon");
            var room = document.getElementById("accuse-location");
            var suspect = document.getElementById("accuse-suspect");

            weapon = weapon.options[ weapon.selectedIndex ].value;
            room = room.options[ room.selectedIndex ].value;
            suspect = suspect.options[ suspect.selectedIndex ].value;

            if(idToText[solution_cards["Weapons"][0]]["name"] == weapon &&
               idToText[solution_cards["Rooms"][0]]["name"] == room &&
               idToText[solution_cards["Suspects"][0]]["name"] == suspect){
                alert('You Won!!!');
                url = "/play/?player_status=won";
            }
            else{
                alert('You lost...');
                url = "/play/?player_status=lost";
            };

            $.ajax({
                type: "POST",
                url: url,
                success: function() {
                    location.reload();
                }
            });
        }

        function makeSuggestion(location, suspect, weapon) {
            $.ajax({
                type: "POST",
                url: "/play/"
            });
        };

        function rebukeSuggestion() {
            $.ajax({
                type: "POST",
                url: "/play/?used_card=foo"
            });
        };

    </script>

    <h2>Game</h2>
    <body>
        <h3>Game Board</h3>
        <img src="assets\board.png" alt="game board picture">
        <h3 id="player-location-msg"></h3>

        <!-- Turn handling -->
        <div class="is-players-turn" id="turn-options-menu">
            <h3>Turn Options</h3>
            <ul id="turn-options">
                <li onclick="move()">Move</li>
                <li onclick="suggest()">Make a Suggestion</li>
                <li onclick="accuse()">Make an Accusation</li>
            </ul>
        </div>

        <div class="is-players-turn" id="move-options-menu">
            <h3>Move Options</h3>
            <button onclick="showTurnOptions()">Back to Turn Options</button>
            <br><br>
            <select id="move-options"></select>
            <button onclick="movePlayer()">Move</button>
            <!--<ul id="move-options">-->
            </ul>
        </div>

        <div class="is-players-turn" id="make-suggestion-menu">
            <h3>Make a Suggestion</h3>
            <button onclick="showTurnOptions()">Back to Turn Options</button>
            <!--<p>Choose one Weapon</p>
            <ul class="weapon-options"></ul>
            <p>Choose one Suspect</p>
            <ul class="suspect-options"></ul>-->
            <p>Choose one Weapon</p>
            <!--<ul class="weapon-options"></ul>-->
            <select id="suggest-weapon"></select>
            <p>Choose one Suspect</p>
            <!--<ul class="suspect-options"></ul>-->
            <select id="suggest-suspect"></select>
            <button onclick="makeSuggestion('{{ player_location }}', selectedWeapon, selectedSuspect)">Suggest</button>
        </div>

        <div class="is-players-turn" id="make-accusation-menu">
            <h3>Make an Accusation</h3>
            <button onclick="showTurnOptions()">Back to Turn Options</button>
            <p><em>NOTE: if you make an incorrect Accusation, you automatically lose the game.</em></p>
            <p>Choose one Weapon</p>
            <!--<ul class="weapon-options"></ul>-->
            <select id="accuse-weapon"></select>
            <p>Choose one Suspect</p>
            <!--<ul class="suspect-options"></ul>-->
            <select id="accuse-suspect"></select>
            <p>Choose one Room</p>
            <!--<ul class="location-options"></ul>-->
            <select id="accuse-location"></select>
            <button onclick="makeAccusation()">Accuse</button>
        </div>

        <!-- Player hand -->
        <h3>Your Hand</h3>
        <ul id="player-hand">
        </ul>
    </body>

    <script
      src="http://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>

{% endblock %}